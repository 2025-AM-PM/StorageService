# 워크플로우 이름
name: ampm-storage TEST CI/CD

# 워크플로우 실행 조건 (develop 브랜치)
on:
  pull_request:
    branches: [ "develop" ]
  push:
    branches: [ "develop" ]

# 워크플로우 전체에서 사용할 환경 변수
env:
  JAVA_VERSION: '21'
  APP_NAME: ampm-storage-test # 프로덕션 컨테이너와 이름 충돌 방지

jobs:
  # =======================================================
  # 1. CI Job (develop 브랜치로의 Pull Request 시 실행)
  # =======================================================
  ci:
    name: Continuous Integration (Test)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Build and Test with Gradle
        run: ./gradlew build

  # =========================================================================
  # 2. CD Job (develop 브랜치에 Push(Merge) 시 실행)
  # =========================================================================
  cd:
    name: Continuous Deployment (Test)
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop' # develop 브랜치에 Push될 때만 실행
    runs-on: ubuntu-latest
    steps:
      # (1) 소스 코드 가져오기
      - name: Checkout source code
        uses: actions/checkout@v4

      # (2) 배포할 소스 코드를 zip 파일로 압축
      - name: Archive source code
        run: zip -r source.zip .

      # (3) 압축된 소스 코드를 서버로 복사 (SCP)
      - name: Copy source code to TEST server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.TEST_DEPLOY_HOST }}
          username: ${{ secrets.TEST_DEPLOY_USER }}
          password: ${{ secrets.TEST_DEPLOY_SSH_PASSWORD }}
          port: ${{ secrets.TEST_DEPLOY_PORT }}
          source: "source.zip"
          target: /home/${{ secrets.TEST_DEPLOY_USER }}/app/

      # (4) 서버에 접속하여 배포 실행 (SSH)
      - name: Deploy on TEST server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          SECRET_KEY: ${{ secrets.TEST_APP_STORAGE_SECRET_KEY }}
        with:
          host: ${{ secrets.TEST_DEPLOY_HOST }}
          username: ${{ secrets.TEST_DEPLOY_USER }}
          password: ${{ secrets.TEST_DEPLOY_SSH_PASSWORD }}
          port: ${{ secrets.TEST_DEPLOY_PORT }}
          script: |
            # 🚨 -x 옵션을 추가하여 모든 실행 명령어를 로그에 출력합니다.
            set -euxo pipefail
            echo "🚀 Starting deployment on TEST server..."
            
            cd /home/${{ secrets.TEST_DEPLOY_USER }}/app/

            echo "📦 Unzipping source code..."
            unzip -o source.zip
            rm source.zip

            echo "🐳 Building new Docker image from source..."
            docker build -t ${{ env.APP_NAME }} .

            echo "🛑 Stopping and removing old container..."
            docker stop ${{ env.APP_NAME }} || true
            docker rm ${{ env.APP_NAME }} || true

            echo "▶️ Running new container..."
            docker run -d \
              -p 6737:6736 \
              --name ${{ env.APP_NAME }} \
              -v /data/storage_test:/files \
              -e SPRING_PROFILES_ACTIVE=test \
              -e APP_STORAGE_SECRET_KEY="$SECRET_KEY" \
              -e APP_STORAGE_UPLOAD_DIR=/files \
              ${{ env.APP_NAME }}
            
            # --- 👇 [디버깅 코드 추가] ---
            echo "⏳ Waiting 5 seconds for container to initialize..."
            sleep 5

            echo "🔎 Checking container status..."
            docker ps -a --filter "name=${{ env.APP_NAME }}"

            echo "📋 Fetching container logs..."
            docker logs ${{ env.APP_NAME }}
            # --- 👆 [디버깅 코드 추가] ---
            
            echo "🎉 TEST Deployment successful!"

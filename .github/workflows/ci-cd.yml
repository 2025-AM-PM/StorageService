# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: ampm-storage CI/CD (Production)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ (main ë¸Œëœì¹˜)
on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

# ì›Œí¬í”Œë¡œìš° ì „ì²´ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜
env:
  JAVA_VERSION: '21'
  APP_NAME: ampm-storage # ğŸš¨ í”„ë¡œë•ì…˜ ì•± ì´ë¦„

jobs:
  # =======================================================
  # 1. CI Job (main ë¸Œëœì¹˜ë¡œì˜ Pull Request ì‹œ ì‹¤í–‰)
  # =======================================================
  ci:
    name: Continuous Integration (Production)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build and Test with Gradle
        run: ./gradlew build

  # =========================================================================
  # 2. CD Job (main ë¸Œëœì¹˜ì— Push(Merge) ì‹œ ì‹¤í–‰)
  # =========================================================================
  cd:
    name: Continuous Deployment (Production)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' # ğŸš¨ ì‹¤í–‰ ë¸Œëœì¹˜: main
    runs-on: ubuntu-latest
    steps:
      # (1) ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout source code
        uses: actions/checkout@v4

      # (2) ë°°í¬í•  ì†ŒìŠ¤ ì½”ë“œë¥¼ zip íŒŒì¼ë¡œ ì••ì¶• (ìµœì í™”)
      - name: Archive source code
        run: zip -r source.zip . -x ".git/*" -x ".github/*"

      # (3) ì••ì¶•ëœ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì„œë²„ë¡œ ë³µì‚¬ (SCP)
      - name: Copy source code to Production server
        uses: appleboy/scp-action@v0.1.4
        with:
          # ğŸš¨ í”„ë¡œë•ì…˜ ì„œë²„ìš© Secret ì‚¬ìš©
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_SSH_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT }}
          source: "source.zip"
          target: ${{ secrets.MAIN_STORAGE_BASE }}/ 
          rm: true 

      # (4) Secretì„ GitHub Actions í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
      - name: Set secrets as environment variables
        run: |
          echo "SECRET_KEY=${{ secrets.APP_STORAGE_SECRET_KEY }}" >> $GITHUB_ENV
          echo "STORAGE_PATH=${{ secrets.MAIN_STORAGE_BASE }}" >> $GITHUB_ENV

      # (5) ì„œë²„ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ì‹¤í–‰ (SSH) (âœ… ìˆ˜ì •ë¨)
      - name: Deploy on Production server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # --- âš ï¸ ì´ ë¶€ë¶„ë“¤ì´ ëˆ„ë½ë˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤ ---
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_SSH_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT }}
          # -----------------------------------------------
          
          envs: SECRET_KEY,STORAGE_PATH
          script: |
            set -euo pipefail
            
            # (A) íƒ€ê²Ÿ ë””ë ‰í† ë¦¬(STORAGE_PATH)ë¡œ ì´ë™
            echo "ğŸš€ Starting deployment in $STORAGE_PATH..."
            cd $STORAGE_PATH

            # (B) ì†ŒìŠ¤ ì½”ë“œ ì••ì¶• í•´ì œ (ê°™ì€ ìœ„ì¹˜)
            echo "ğŸ“¦ Unzipping source code..."
            unzip -o source.zip
            rm source.zip

            # (C) Docker ì´ë¯¸ì§€ ë¹Œë“œ (ê°™ì€ ìœ„ì¹˜)
            echo "ğŸ³ Building new Docker image from source..."
            docker build -t ${{ env.APP_NAME }} .

            # (D) ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ
            echo "ğŸ›‘ Stopping and removing old container..."
            docker stop ${{ env.APP_NAME }} || true
            docker rm ${{ env.APP_NAME }} || true

            # (E) ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ì£¼ì„ ì œê±°ë¨)
            echo "â–¶ï¸ Running new container..."
            docker run -d \
              -p 6736:6736 \
              --name ${{ env.APP_NAME }} \
              -v "$STORAGE_PATH:/files" \
              -e SPRING_PROFILES_ACTIVE=main \
              -e APP_STORAGE_SECRET_KEY="$SECRET_KEY" \
              -e APP_STORAGE_UPLOAD_DIR=/files \
              ${{ env.APP_NAME }}
            
            echo "ğŸ‰ Production Deployment successful!"

# .github/workflows/storage-ci-cd.yml
name: ampm-storage CI/CD (Unified)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ (mainê³¼ develop ë¸Œëœì¹˜)
on:
  pull_request:
    branches: [ "main", "develop" ]
  push:
    branches: [ "main", "develop" ]

# ì›Œí¬í”Œë¡œìš° ì „ì²´ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜
env:
  JAVA_VERSION: '21'

jobs:
  # =======================================================
  # 1. CI Job (main/develop ë¸Œëœì¹˜ë¡œì˜ Pull Request ì‹œ ì‹¤í–‰)
  # =======================================================
  ci:
    name: Continuous Integration
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build and Test with Gradle
        run: ./gradlew build

  # =========================================================================
  # 2. CD Job (main/develop ë¸Œëœì¹˜ì— Push(Merge) ì‹œ ì‹¤í–‰)
  # =========================================================================
  cd:
    name: Continuous Deployment
    # PUSH ì´ë²¤íŠ¸ì´ë©´ì„œ, main ë˜ëŠ” develop ë¸Œëœì¹˜ì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      # (1) ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout source code
        uses: actions/checkout@v4

      # (2) ë°°í¬í•  ì†ŒìŠ¤ ì½”ë“œë¥¼ zip íŒŒì¼ë¡œ ì••ì¶• (ìµœì í™”)
      - name: Archive source code
        run: zip -r source.zip . -x ".git/*" -x ".github/*"

      # (3) [ìˆ˜ì •] ë¸Œëœì¹˜ì— ë”°ë¼ í™˜ê²½ ë³€ìˆ˜ ì„ íƒ
      - name: Pick environment
        shell: bash
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [ "$BRANCH" = "main" ]; then
            {
              echo "APP_NAME=ampm-storage"
              echo "PROFILE=main"
              echo "HOST=${{ secrets.DEPLOY_HOST }}"
              echo "USER=${{ secrets.DEPLOY_USER }}"
              echo "PASSWORD=${{ secrets.DEPLOY_SSH_PASSWORD }}"
              echo "SSH_PORT=${{ secrets.DEPLOY_PORT }}"
              echo "STORAGE_BASE=${{ secrets.MAIN_STORAGE_BASE }}"
              echo "APP_PORT=6736"
              echo "APP_STORAGE_SECRET=${{ secrets.MAIN_APP_STORAGE_SECRET_KEY }}"
            } >> $GITHUB_ENV
          elif [ "$BRANCH" = "develop" ]; then
            {
              echo "APP_NAME=ampm-storage-test"
              echo "PROFILE=test"
              echo "HOST=${{ secrets.TEST_DEPLOY_HOST }}"
              echo "USER=${{ secrets.TEST_DEPLOY_USER }}"
              echo "PASSWORD=${{ secrets.TEST_DEPLOY_SSH_PASSWORD }}"
              echo "SSH_PORT=${{ secrets.TEST_DEPLOY_PORT }}"
              echo "STORAGE_BASE=${{ secrets.TEST_STORAGE_BASE }}"
              echo "APP_PORT=6737"
              echo "APP_STORAGE_SECRET=${{ secrets.TEST_APP_STORAGE_SECRET_KEY }}"
            } >> $GITHUB_ENV
          fi

      # (4) [ìˆ˜ì •] ì••ì¶•ëœ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì„œë²„ë¡œ ë³µì‚¬ (ë³€ìˆ˜ ì‚¬ìš©)
      - name: Copy source code to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          password: ${{ env.PASSWORD }}
          port: ${{ env.SSH_PORT }}
          source: "source.zip"
          target: ${{ env.STORAGE_BASE }}/
          rm: true

      # (5) [ìˆ˜ì •] ì„œë²„ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ì‹¤í–‰ (ë³€ìˆ˜ ì‚¬ìš©)
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          password: ${{ env.PASSWORD }}
          port: ${{ env.SSH_PORT }}

          # Pick environmentì—ì„œ ì„¤ì •í•œ ë³€ìˆ˜ë“¤ì„ SSH ì„¸ì…˜ìœ¼ë¡œ ì „ë‹¬
          envs: APP_NAME, PROFILE, STORAGE_BASE, APP_PORT, APP_STORAGE_SECRET

          script: |
            set -euo pipefail
            
            # (A) íƒ€ê²Ÿ ë””ë ‰í† ë¦¬(STORAGE_BASE)ë¡œ ì´ë™
            echo "ğŸš€ Starting deployment in $STORAGE_BASE..."
            cd $STORAGE_BASE

            # (B) ì†ŒìŠ¤ ì½”ë“œ ì••ì¶• í•´ì œ (ê°™ì€ ìœ„ì¹˜)
            echo "ğŸ“¦ Unzipping source code..."
            unzip -o source.zip
            rm source.zip

            # (C) Docker ì´ë¯¸ì§€ ë¹Œë“œ (ê°™ì€ ìœ„ì¹˜)
            echo "ğŸ³ Building new Docker image from source..."
            docker build -t $APP_NAME .

            # (D) ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ
            echo "ğŸ›‘ Stopping and removing old container..."
            docker stop $APP_NAME || true
            docker rm $APP_NAME || true

            # (E) ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë³€ìˆ˜í™”ë¨)
            echo "â–¶ï¸ Running new container..."
            docker run -d \
              -p $APP_PORT:6736 \
              --name $APP_NAME \
              -v "$STORAGE_BASE:/files" \
              -e SPRING_PROFILES_ACTIVE=$PROFILE \
              -e APP_STORAGE_SECRET_KEY="$APP_STORAGE_SECRET" \
              -e APP_STORAGE_UPLOAD_DIR=/files \
              $APP_NAME
            
            echo "ğŸ‰ Deployment successful!"
# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: ampm-storage CI/CD

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
Â  pull_request:
Â  Â  branches: [ "main" ]
Â  push:
Â  Â  branches: [ "main" ]

# ì›Œí¬í”Œë¡œìš° ì „ì²´ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜
env:
Â  JAVA_VERSION: '21'
Â  APP_NAME: ampm-storage

jobs:
Â  # ==================================================
Â  # 1. CI Job (main ë¸Œëœì¹˜ë¡œì˜ Pull Request ì‹œ ì‹¤í–‰)
Â  # ==================================================
Â  ci:
Â  Â  name: Continuous Integration
Â  Â  if: github.event_name == 'pull_request'
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  - name: Checkout source code
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  - name: Set up JDK 21
Â  Â  Â  Â  uses: actions/setup-java@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  distribution: 'temurin'
Â  Â  Â  Â  Â  java-version: ${{ env.JAVA_VERSION }}
Â  Â  Â  Â  Â  cache: 'gradle'
Â  Â  Â  - name: Grant execute permission for gradlew
Â  Â  Â  Â  run: chmod +x gradlew
Â  Â  Â  - name: Build and Test with Gradle
Â  Â  Â  Â  run: ./gradlew build

Â  # ========================================================================
Â  # 2. CD Job (main ë¸Œëœì¹˜ì— Push(Merge) ì‹œ ì‹¤í–‰)
Â  # ========================================================================
Â  cd:
Â  Â  name: Continuous Deployment
Â  Â  if: github.event_name == 'push' && github.ref == 'refs/heads/main'
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  # (1) ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
Â  Â  Â  - name: Checkout source code
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  # (2) ë°°í¬í•  ì†ŒìŠ¤ ì½”ë“œë¥¼ zip íŒŒì¼ë¡œ ì••ì¶•
Â  Â  Â  - name: Archive source code
Â  Â  Â  Â  run: zip -r source.zip .

Â  Â  Â  # (3) ì••ì¶•ëœ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì„œë²„ë¡œ ë³µì‚¬ (SCP)
Â  Â  Â  - name: Copy source code to server
Â  Â  Â  Â  uses: appleboy/scp-action@v0.1.4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  host: ${{ secrets.DEPLOY_HOST }}
Â  Â  Â  Â  Â  username: ${{ secrets.DEPLOY_USER }}
Â  Â  Â  Â  Â  password: ${{ secrets.DEPLOY_SSH_PASSWORD }}
Â  Â  Â  Â  Â  port: ${{ secrets.DEPLOY_PORT }}
Â  Â  Â  Â  Â  source: "source.zip"
Â  Â  Â  Â  Â  target: /home/${{ secrets.DEPLOY_USER }}/app/

Â  Â  Â  # (4) ì„œë²„ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ì‹¤í–‰ (SSH)
Â  Â  Â  - name: Deploy on server via SSH
Â  Â  Â  Â  uses: appleboy/ssh-action@v1.0.3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  host: ${{ secrets.DEPLOY_HOST }}
Â  Â  Â  Â  Â  username: ${{ secrets.DEPLOY_USER }}
Â  Â  Â  Â  Â  password: ${{ secrets.DEPLOY_SSH_PASSWORD }}
Â  Â  Â  Â  Â  port: ${{ secrets.DEPLOY_PORT }}
Â  Â  Â  Â  Â  script: |
Â  Â  Â  Â  Â  Â  set -euo pipefail
Â  Â  Â  Â  Â  Â  echo "ğŸš€ Starting deployment on server..."
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  # íƒ€ê²Ÿ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
Â  Â  Â  Â  Â  Â  cd /home/${{ secrets.DEPLOY_USER }}/app/

Â  Â  Â  Â  Â  Â  echo "ğŸ“¦ Unzipping source code..."
Â  Â  Â  Â  Â  Â  unzip -o source.zip
Â  Â  Â  Â  Â  Â  rm source.zip

Â  Â  Â  Â  Â  Â  echo "ğŸ³ Building new Docker image from source..."
Â  Â  Â  Â  Â  Â  docker build -t ${{ env.APP_NAME }} .

Â  Â  Â  Â  Â  Â  echo "ğŸ›‘ Stopping and removing old container..."
Â  Â  Â  Â  Â  Â  docker stop ${{ env.APP_NAME }} || true
Â  Â  Â  Â  Â  Â  docker rm ${{ env.APP_NAME }} || true

Â  Â  Â  Â  Â  Â  echo "â–¶ï¸ Running new container..."
Â  Â  Â  Â  Â  Â  docker run -d \
Â  Â  Â  Â  Â  Â  Â  -p 6736:6736 \
Â  Â  Â  Â  Â  Â  Â  --name ${{ env.APP_NAME }} \
Â  Â  Â  Â  Â  Â  Â  -v ${{ secrets.MAIN_STORAGE_BASE }}:/files \  # <--- ì´ ë¶€ë¶„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤
Â  Â  Â  Â  Â  Â  Â  -e SPRING_PROFILES_ACTIVE=main \
Â  Â  Â  Â  Â  Â  Â  -e APP_STORAGE_SECRET_KEY="${{ secrets.APP_STORAGE_SECRET_KEY }}" \
Â  Â  Â  Â  Â  Â  Â  -e APP_STORAGE_UPLOAD_DIR=/files \
Â  Â  Â  Â  Â  Â  Â  ${{ env.APP_NAME }}
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  echo "ğŸ‰ Deployment successful!"

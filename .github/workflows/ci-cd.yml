# .github/workflows/storage-ci-cd.yml
name: ampm-storage CI/CD (Dockerfile-based)

on:
  pull_request:
    branches: [ "main", "develop" ]
  push:
    branches: [ "main", "develop" ]

env:
  JAVA_VERSION: '21'
  TZ: 'Asia/Seoul'

jobs:
  # =======================================================
  # 1. CI Job (Pull Request ì‹œ ì‹¤í–‰) - ë³€ê²½ ì—†ìŒ
  # =======================================================
  ci:
    name: Continuous Integration
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Build and Test with Gradle
        run: ./gradlew build

  # =========================================================================
  # 2. CD Job (Push(Merge) ì‹œ ì‹¤í–‰) - Dockerfile ê¸°ì¤€ ìˆ˜ì •
  # =========================================================================
  cd:
    name: Continuous Deployment
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      # (1) ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout source code
        uses: actions/checkout@v4

      # (2) JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      # (3) Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # (4) Gradle ë¹Œë“œ (jar íŒŒì¼ ìƒì„±)
      - name: Build jar (skip tests)
        run: ./gradlew clean bootJar -x test

      # (5) ë°°í¬í•  ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„ (app.jar)
      # Dockerfileì´ 'COPY app.jar ...'ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì´ë¦„ì„ 'app.jar'ë¡œ ë³€ê²½
      - name: Prepare artifact for deployment
        shell: bash
        run: |
          JAR=$(find . -type f -path "*/build/libs/*.jar" | head -n 1)
          cp "$JAR" app.jar
          echo "Copied $JAR to app.jar"

      # (6) ë¸Œëžœì¹˜ì— ë”°ë¼ í™˜ê²½ ë³€ìˆ˜ ì„ íƒ
      - name: Pick environment
        shell: bash
        run: |
          BRANCH="${GITHUB_REF##*/}"
          # Dockerfileì˜ 'EXPOSE 6736'ì´ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸
          INTERNAL_PORT=6736
          
          # application.propertiesì˜ 'app.storage.upload-dir: files'ì™€
          # Dockerfileì˜ 'WORKDIR /app'ë¥¼ ì¡°í•©í•œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œ
          INTERNAL_UPLOAD_DIR="/app/files"

          if [ "$BRANCH" = "main" ]; then
            {
              echo "APP_NAME=ampm-storage"
              echo "PROFILE=main"
              echo "HOST=${{ secrets.DEPLOY_HOST }}"
              echo "USER=${{ secrets.DEPLOY_USER }}"
              echo "PASSWORD=${{ secrets.DEPLOY_SSH_PASSWORD }}"
              echo "SSH_PORT=${{ secrets.DEPLOY_PORT }}"
              echo "DIR=~/ampm-storage" # ì•± ë°°í¬ ë””ë ‰í„°ë¦¬ (app.jar, Dockerfile, .env ìœ„ì¹˜)
              echo "STORAGE_BASE=${{ secrets.MAIN_STORAGE_BASE }}" # ì‹¤ì œ íŒŒì¼ ì €ìž¥(ë³¼ë¥¨) ë””ë ‰í„°ë¦¬
              echo "APP_PORT=6736" # ì™¸ë¶€ ë…¸ì¶œ í¬íŠ¸
              echo "APP_STORAGE_SECRET=${{ secrets.MAIN_APP_STORAGE_SECRET_KEY }}"
          
              # .env íŒŒì¼ì— ìž‘ì„±ë  ê°’ë“¤
              echo "ENV_SPRING_APP_NAME=AmpmStorage"
              echo "ENV_INTERNAL_PORT=$INTERNAL_PORT"
              echo "ENV_UPLOAD_DIR=$INTERNAL_UPLOAD_DIR"
              echo "ENV_MAX_FILE_SIZE=10MB"
              echo "ENV_MAX_REQ_SIZE=10MB"
            } >> $GITHUB_ENV
          elif [ "$BRANCH" = "develop" ]; then
            {
              echo "APP_NAME=ampm-storage-test"
              echo "PROFILE=test"
              echo "HOST=${{ secrets.TEST_DEPLOY_HOST }}"
              echo "USER=${{ secrets.TEST_DEPLOY_USER }}"
              echo "PASSWORD=${{ secrets.TEST_DEPLOY_SSH_PASSWORD }}"
              echo "SSH_PORT=${{ secrets.TEST_DEPLOY_PORT }}"
              echo "DIR=~/ampm-storage-test" # ì•± ë°°í¬ ë””ë ‰í„°ë¦¬
              echo "STORAGE_BASE=${{ secrets.TEST_STORAGE_BASE }}" # ì‹¤ì œ íŒŒì¼ ì €ìž¥(ë³¼ë¥¨) ë””ë ‰í„°ë¦¬
              echo "APP_PORT=6737" # ì™¸ë¶€ ë…¸ì¶œ í¬íŠ¸ (ë‚´ë¶€ 6736ê³¼ ë‹¤ë¦„)
              echo "APP_STORAGE_SECRET=${{ secrets.TEST_APP_STORAGE_SECRET_KEY }}"
          
              # .env íŒŒì¼ì— ìž‘ì„±ë  ê°’ë“¤
              echo "ENV_SPRING_APP_NAME=AmpmStorage-Test"
              echo "ENV_INTERNAL_PORT=$INTERNAL_PORT"
              echo "ENV_UPLOAD_DIR=$INTERNAL_UPLOAD_DIR"
              echo "ENV_MAX_FILE_SIZE=10MB"
              echo "ENV_MAX_REQ_SIZE=10MB"
            } >> $GITHUB_ENV
          fi

      # (7) ì›ê²© ì„œë²„ì— ë””ë ‰í„°ë¦¬ ìƒì„± (ì•± ë””ë ‰í„°ë¦¬ + ë³¼ë¥¨ ë””ë ‰í„°ë¦¬)
      - name: Make remote dirs
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          password: ${{ env.PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            mkdir -p "${{ env.DIR }}"
            mkdir -p "${{ env.STORAGE_BASE }}"

      # (8) app.jarì™€ Dockerfileë§Œ ì„œë²„ë¡œ ë³µì‚¬
      - name: Copy app.jar & Dockerfile to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          password: ${{ env.PASSWORD }}
          port: ${{ env.SSH_PORT }}
          source: "app.jar,Dockerfile"
          target: "${{ env.DIR }}/"

      # (9) ì„œë²„ì—ì„œ .env ìƒì„± ë° ë„ì»¤ ì‹¤í–‰
      - name: Deploy on server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          password: ${{ env.PASSWORD }}
          port: ${{ env.SSH_PORT }}

          # Pick environmentì—ì„œ ì„¤ì •í•œ ëª¨ë“  ë³€ìˆ˜ë“¤ì„ SSH ì„¸ì…˜ìœ¼ë¡œ ì „ë‹¬
          envs: |
            APP_NAME, PROFILE, DIR, STORAGE_BASE, APP_PORT, 
            APP_STORAGE_SECRET, ENV_SPRING_APP_NAME, 
            ENV_INTERNAL_PORT, ENV_UPLOAD_DIR, 
            ENV_MAX_FILE_SIZE, ENV_MAX_REQ_SIZE, TZ

          script: |
            set -euo pipefail
            
            # (A) ì•± ë””ë ‰í† ë¦¬(DIR)ë¡œ ì´ë™
            echo "ðŸš€ Starting deployment in $DIR..."
            cd $DIR

            # (B) .env íŒŒì¼ ìƒì„±
            # Dockerfileì˜ 'ENV TZ'ì™€ 'EXPOSE'ëŠ” .env íŒŒì¼ë¡œ ëŒ€ì²´/í†µì¼
            echo "Writing .env file..."
            cat > .env <<EOF
            # Dockerfileì˜ 'ENV TZ=Asia/Seoul'
            TZ=$TZ
            
            # Spring í”„ë¡œí•„
            SPRING_PROFILES_ACTIVE=$PROFILE
            
            # Dockerfileì˜ 'EXPOSE 6736' (application.propertiesì˜ 'server.port')
            SERVER_PORT=$ENV_INTERNAL_PORT
            
            # application.propertiesì˜ 'spring.application.name'
            SPRING_APPLICATION_NAME=$ENV_SPRING_APP_NAME
            
            # application.propertiesì˜ 'app.storage.secret-key'
            APP_STORAGE_SECRET_KEY=$APP_STORAGE_SECRET
            
            # application.propertiesì˜ 'app.storage.upload-dir'
            APP_STORAGE_UPLOAD_DIR=$ENV_UPLOAD_DIR
            
            # application.propertiesì˜ multipart ì„¤ì •
            SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=$ENV_MAX_FILE_SIZE
            SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=$ENV_MAX_REQ_SIZE
            EOF

            # (C) Docker ì´ë¯¸ì§€ ë¹Œë“œ (ì„œë²„ì—ì„œ app.jarì™€ Dockerfile ì‚¬ìš©)
            echo "ðŸ³ Building new Docker image: $APP_NAME"
            docker build -t $APP_NAME .

            # (D) ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ
            echo "ðŸ›‘ Stopping and removing old container: $APP_NAME"
            docker stop $APP_NAME || true
            docker rm $APP_NAME || true

            # (E) ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë³¼ë¥¨ ë° .env íŒŒì¼ ì‚¬ìš©)
            echo "â–¶ï¸ Running new container: $APP_NAME"
            docker run -d \
              --name $APP_NAME \
              --restart unless-stopped \
              --env-file .env \
              -p "$APP_PORT:$ENV_INTERNAL_PORT" \
              -v "$STORAGE_BASE:$ENV_UPLOAD_DIR" \
              $APP_NAME:latest
            
            echo "ðŸŽ‰ Deployment successful!"